generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum OrientacionForzada {
  LARGO
  ANCHO
  ALTO
}

model TipoProducto {
  id                          Int       @id @default(autoincrement())
  division_servicio_id        Int
  dadora_id                   Int
  un_venta_id                 Int
  un_entrega_id               Int
  created_at                  DateTime
  updated_at                  DateTime?
  deleted_at                  DateTime?
  habilitado                  Boolean   @default(true)
  created_by                  String?
  updated_by                  String?
  codigo                      String    @unique
  descripcion                 String
  unidades_por_unidad_entrega Int
  peso_por_unidad_venta       Int
  peso_por_uniad_entrega      Int
  volumen_por_unidad_entrega  Int
  unidad_entra_por_bulto      Int
  alto_por_bulto              Int
  ancho_por_bulto             Int
  largo_por_bulto             Int
  peso_por_bulto              Int
  volumen_por_bulto           Int

  cubicaciones                   Cubicacion[]
  contenedores                   TipoContenedorProducto[]
  cubicacionProductoBulto        CubicacionProductoBulto? // <- opcional
  cubicacionProductoBultoItems   CubicacionProductoBultoItem[]
  cubicacionesProductoContenedor CubicacionProductoContenedor[]
  reglasCubicacion               CubicacionRegla[]

  divisionServicio DivisionServicio @relation(fields: [division_servicio_id], references: [id])

  @@map("tipo_producto")
}

model CubicacionProductoBulto {
  id Int @id @default(autoincrement())

  tipo_producto_id Int          @unique
  tipoProducto     TipoProducto @relation(fields: [tipo_producto_id], references: [id])

  largo_unidad_mm Int
  ancho_unidad_mm Int
  alto_unidad_mm  Int

  grosor_pared_mm Int @default(0)

  unidades_eje_x Int
  unidades_eje_y Int
  unidades_eje_z Int

  ocupacion_interna Decimal @default(0.0) @db.Decimal(5, 2)

  orient_largo_mm Int
  orient_ancho_mm Int
  orient_alto_mm  Int

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  items CubicacionProductoBultoItem[]

  @@map("cubicacion_producto_bulto")
}

model CubicacionProductoBultoItem {
  id Int @id @default(autoincrement())

  cubicacion_producto_bulto_id Int
  tipo_producto_id             Int

  cantidad Int

  largo_unidad_mm Int
  ancho_unidad_mm Int
  alto_unidad_mm  Int

  unidades_eje_x Int
  unidades_eje_y Int
  unidades_eje_z Int

  orient_largo_mm Int
  orient_ancho_mm Int
  orient_alto_mm  Int

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  cubicacionProductoBulto CubicacionProductoBulto @relation(fields: [cubicacion_producto_bulto_id], references: [id])
  tipoProducto             TipoProducto             @relation(fields: [tipo_producto_id], references: [id])

  @@unique([cubicacion_producto_bulto_id, tipo_producto_id])
  @@map("cubicacion_producto_bulto_item")
}

model Cubicacion {
  id             Int      @id @default(autoincrement())
  createdAt      DateTime @default(now())
  descripcion    String?
  tipoProductoId Int
  cantidadBultos Int
  volumenTotalM3 Float

  tipoProducto TipoProducto @relation(fields: [tipoProductoId], references: [id])
}

model CubicacionProductoContenedor {
  id Int @id @default(autoincrement())

  // Relación con producto y contenedor
  tipo_producto_id   Int
  tipo_contenedor_id Int

  tipoProducto   TipoProducto   @relation(fields: [tipo_producto_id], references: [id])
  tipoContenedor TipoContenedor @relation(fields: [tipo_contenedor_id], references: [id])

  // Parámetros usados en el cálculo
  altura_max_carga_m Decimal? @db.Decimal(6, 2)

  // Resultado de cubicación (bultos ↔ pallet/contenedor)
  cajas_por_capa     Int
  capas              Int
  cajas_totales      Int
  productos_por_caja Int
  productos_totales  Int
  ocupacion_volumen  Decimal @db.Decimal(5, 2)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([tipo_producto_id, tipo_contenedor_id])
  @@map("cubicacion_producto_contenedor")
}

model TipoContenedor {
  id             Int       @id @default(autoincrement())
  created_at     DateTime
  updated_at     DateTime?
  deleted_at     DateTime?
  habilitado     Boolean   @default(true)
  created_by     String?
  updated_by     String?
  codigo         String    @unique
  descripcion    String
  largo_mts      Float
  ancho_mts      Float
  alto_mts       Float
  peso_pallet_kg Float
  peso_max_kg    Float
  peso_max_lts   Float

  productos                      TipoContenedorProducto[]
  cubicacionesProductoContenedor CubicacionProductoContenedor[]
  cubicacionReglas               CubicacionRegla[]

  @@map("tipo_contenedor")
}

model TipoContenedorProducto {
  tipo_contenedor_id Int
  tipo_producto_id   Int
  cantidad_max_items Int

  contenedor TipoContenedor @relation(fields: [tipo_contenedor_id], references: [id])
  producto   TipoProducto   @relation(fields: [tipo_producto_id], references: [id])

  @@id([tipo_contenedor_id, tipo_producto_id])
  @@map("tipo_contenedor_producto")
}

model DivisionServicio {
  id          Int       @id @default(autoincrement())
  created_at  DateTime  @default(now())
  updated_at  DateTime?
  deleted_at  DateTime?
  habilitado  Boolean   @default(true)
  created_by  String?
  updated_by  String?
  codigo      String    @unique
  descripcion String

  productos             TipoProducto[]
  clasificaciones       TransporteClasificacion[]
  unidadesMedidaEntrega TipoUnidadMedidaEntrega[]
  unidadesMedidaVenta   TipoUnidadMedidaVenta[]

  @@map("division_servicio")
}

model TipoUnidadMedida {
  id          Int       @id @default(autoincrement())
  created_at  DateTime  @default(now())
  updated_at  DateTime?
  deleted_at  DateTime?
  habilitado  Boolean   @default(true)
  created_by  String?
  updated_by  String?
  codigo      String    @unique
  descripcion String

  @@map("tipo_unidad_medida")
}

model TipoUnidadMedidaEntrega {
  id                   Int       @id @default(autoincrement())
  division_servicio_id Int?
  created_at           DateTime  @default(now())
  updated_at           DateTime?
  deleted_at           DateTime?
  habilitado           Boolean   @default(true)
  created_by           String?
  updated_by           String?
  codigo               String    @unique
  descripcion          String

  divisionServicio DivisionServicio? @relation(fields: [division_servicio_id], references: [id])

  @@map("tipo_unidad_medida_entrega")
}

model TipoUnidadMedidaVenta {
  id                   Int       @id @default(autoincrement())
  division_servicio_id Int?
  created_at           DateTime  @default(now())
  updated_at           DateTime?
  deleted_at           DateTime?
  habilitado           Boolean   @default(true)
  created_by           String?
  updated_by           String?
  codigo               String    @unique
  descripcion          String

  divisionServicio DivisionServicio? @relation(fields: [division_servicio_id], references: [id])

  @@map("tipo_unidad_medida_venta")
}

model TransporteClase {
  id              Int                       @id @default(autoincrement())
  codigo          String                    @unique
  descripcion     String
  clasificaciones TransporteClasificacion[]

  transportes Transporte[]

  @@map("transporte_clase")
}

model TransporteClasificacion {
  id                       Int    @id @default(autoincrement())
  clase_transporte_id      Int?
  division_servicio_id     Int
  denominacion_de_vehiculo String
  mt_largo_cub             Int
  mt_ancho_cub             Int
  mt_alto_cub              Int
  mt_total_cub             Int
  max_peso_kg              Int
  max_peso_lt              Int
  max_peso_xmt3            Int
  pallet_europaleta_total  Int
  pallet_ariog_total       String
  pallet_americano_total   String

  clase            TransporteClase? @relation(fields: [clase_transporte_id], references: [id])
  divisionServicio DivisionServicio @relation(fields: [division_servicio_id], references: [id])

  transportes      Transporte[]
  reglasCubicacion CubicacionRegla[]

  @@map("transporte_clasificacion")
}

model CubicacionRegla {
  id Int @id @default(autoincrement())

  empresaId                 Int  @map("empresa_id")
  tipoProductoId            Int? @map("tipo_producto_id")
  tipoContenedorId          Int? @map("tipo_contenedor_id")
  transporteClasificacionId Int? @map("transporte_clasificacion_id")

  maxCodigosPorPallet Int?                @map("max_codigos_por_pallet")
  maxAlturaM          Decimal?            @map("max_altura_m") @db.Decimal(6, 2)
  permitirMezcla      Boolean             @default(true) @map("permitir_mezcla")
  orientacionForzada  OrientacionForzada? @map("orientacion_forzada")
  observaciones       String?             @db.VarChar(255)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  empresa                 empresa                  @relation(fields: [empresaId], references: [id])
  tipoProducto            TipoProducto?            @relation(fields: [tipoProductoId], references: [id])
  tipoContenedor          TipoContenedor?          @relation(fields: [tipoContenedorId], references: [id])
  transporteClasificacion TransporteClasificacion? @relation(fields: [transporteClasificacionId], references: [id])

  @@index([empresaId, tipoProductoId, tipoContenedorId, transporteClasificacionId], name: "idx_empresa_producto_contenedor_transporte")
  @@map("cubicacion_regla")
}

model empresa {
  id             Int    @id @default(autoincrement())
  codigo_empresa String @db.VarChar(255)
  razon_social   String @db.VarChar(255)

  created_at DateTime  @default(now()) @db.DateTime(0)
  updated_at DateTime? @db.DateTime(0)
  deleted_at DateTime? @db.DateTime(0)
  habilitado Boolean   @default(true)

  // Relaciones que SÍ usamos en cubicación
  transporte       Transporte[]
  cubicacionReglas CubicacionRegla[]

  @@map("empresa")
}

model Transporte {
  id Int @id @default(autoincrement())

  empresaId                 Int  @map("empresa_id")
  claseTransporteId         Int? @map("clase_de_transporte_id")
  transporteClasificacionId Int? @map("transporte_clasificacion_id")

  dominio     String @db.VarChar(255)
  motor       String @db.VarChar(255)
  chasis      String @db.VarChar(255)
  ano         String @db.VarChar(255)
  descripcion String @db.VarChar(255)

  empresa                 empresa                  @relation(fields: [empresaId], references: [id])
  claseTransporte         TransporteClase?         @relation(fields: [claseTransporteId], references: [id])
  clasificacionTransporte TransporteClasificacion? @relation(fields: [transporteClasificacionId], references: [id])

  @@index([empresaId], map: "IDX_TRANSPORTE_EMPRESA")
  @@index([claseTransporteId], map: "IDX_336ADCB45F23D074")
  @@index([transporteClasificacionId], map: "IDX_336ADCB4CLASF")
  @@map("transporte")
}
